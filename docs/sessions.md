# `Session` 管理： `JSONB` + `TTL`

## 核心原理
把 `Session` 存進資料庫表裡，用 `JSONB` 欄位存數據，用 `expires_at` 標記過期。

- **靈活**： `JSONB` 想存什麼存什麼，不用預先定義複雜的表結構。
- **可查詢**：你可以用 `SQL` 直接查出「所有在線的管理員」或「來自某個 `IP` 的所有會話」，這在 `Redis` 裡很難做到。
- **原子性**：這是殺手鐧。你可以在同一個交易裡「更新用戶資料 + 更新 `Session` 」，絕對不會出現數據不一致。

## 與 `Redis` 的對比
| 特性 | `Redis Session` | `Postgres Session` |
| :--- | :--- | :--- |
| **查詢能力** | 只能按 `Key` 查 | `SQL` 全力支持 ( 支持欄位內查詢 ) |
| **一致性** | 最終一致 ( 可能兩邊不統一 ) | **交易強一致** ( 要麼都成，要麼都回滾 ) |
| **清理** | 自動過期 | 需要手動/定時刪除過期行 |
| **性能** | 極快 ( < `0.5` `ms` ) | 正常 ( `1` - `5` `ms` ) |

## 維護建議
1. **定時清理**：必須定期清理過期數據。
   ```sql
   -- 建議每小時刪一次
   DELETE FROM sessions WHERE expires_at < NOW();
   ```
2. **索引**：記得給 `id` 設為主鍵，給 `expires_at` 加索引。

## 什麼時候用？
- **推薦**：大部分 `Web` 應用。除非你的用戶量大到單個資料庫存不下所有 `Session` 。
- **推薦**：需要對 `Session` 進行複雜查詢或統計的業務。
